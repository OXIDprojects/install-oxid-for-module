#!/usr/bin/env bash

OXID=${OXID:-6.0}

if [ -n "$TRAVIS" ]; then
  CI_SYSTEM="travis_ci"
fi
if [ -n "$GITLAB_CI" ]; then
  CI_SYSTEM="gitlab_ci"
fi

if [ -z $CI_SYSTEM ]; then
   echo "CI_SYSTEM couldn't be detected";
   echo "currently supported CI systems:";
   echo "travis, gitlab-ci";
   exit;
fi

TARGET_PATH=$(grep '"target-directory":' composer.json | awk -F'"' '{print $4}')
PACKAGE_NAME=$(grep '"name":' composer.json | awk -F'"' '{print $4}')

echo "installing OXID version ${OXID} in ${CI_SYSTEM}"

cd ~/ || exit
mkdir OXID
cd OXID || exit
OXID_PATH=$(pwd)


composer create-project oxid-esales/oxideshop-project . dev-b-"${OXID}"-ce
sed -i -e "s@<dbHost>@127.0.0.1@g; s@<dbName>@oxid@g; s@<dbUser>@root@g; s@<dbPwd>@@g; s@<sShopURL>@http://127.0.0.1@g; s@sLogLevel = 'error'@sLogLevel = 'info'@g" source/config.inc.php
sed -i -e "s@<sShopDir>@${OXID_PATH}/source@g; s@<sCompileDir>@${OXID_PATH}/source/tmp@g" source/config.inc.php
sed -i -e "s@partial_module_paths: null@partial_module_paths: ${TARGET_PATH}@g" test_config.yml
sed -i -e "s@run_tests_for_shop: true@run_tests_for_shop: false@g" test_config.yml
cat test_config.yml
composer config minimum-stability dev

#Module Registrieren
#composer config repo.packagist false
echo "installing ${PACKAGE_NAME} in ${TARGET_PATH}"
composer config repositories.${CI_SYSTEM} path "${TRAVIS_BUILD_DIR}"
composer clear-cache
composer require "${PACKAGE_NAME}:*"
